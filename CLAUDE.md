# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Bun + Elysia + Drizzle API server designed for Google Cloud Run deployment with PostgreSQL (Cloud SQL) and Redis.

## Commands

```bash
bun install          # Install dependencies
bun run dev          # Development server with hot reload
bun run start        # Production start
bun test             # Run tests (Bun's built-in test runner)

# Database (Drizzle)
bun run db:generate  # Generate migrations from schema changes
bun run db:migrate   # Apply migrations
bun run db:push      # Push schema directly (dev only)

# Type checking
bunx tsc --noEmit
```

## Architecture

### Plugin Composition Order (src/app.ts)
Plugins are applied in specific order: security → cors → observability → rate-limit → swagger → error-handler → routes

### Database Connection (src/config/db.ts)
Dual-mode connection:
- **Cloud Run**: Set `CLOUDSQL_INSTANCE` → uses unix socket `/cloudsql/{instance}`
- **Local dev**: Leave `CLOUDSQL_INSTANCE` unset → uses `DB_HOST:DB_PORT` (for Cloud SQL Auth Proxy)

### Request Context Flow
`requestIdMiddleware` → `timingMiddleware` → route handler → `onAfterHandle` hooks

Context properties added:
- `requestId`: string (from header or generated UUID)
- `startTime`: number (performance.now())

### Error Response Format
All errors return: `{ error: { message, code, requestId? } }`

Codes: `VALIDATION_ERROR` (400), `NOT_FOUND` (404), `PARSE_ERROR` (400), `RATE_LIMIT_EXCEEDED` (429), `PAYLOAD_TOO_LARGE` (413), `INTERNAL_ERROR` (500)

## Code Patterns

### Elysia Routes
- Define in `src/routes/` with `.route.ts` suffix
- Group v1 routes under `src/routes/v1/`
- Mount via `src/routes/_router.ts`

### Drizzle Schema
- Place in `src/db/schema/` with table name as filename
- Export `$inferSelect` and `$inferInsert` types

### Module Structure
```
src/modules/{name}/
├── {name}.controller.ts  # Route handlers
├── {name}.service.ts     # Business logic
├── {name}.repo.ts        # Database queries
└── {name}.schema.ts      # Validation schemas
```

### Singletons
- `getDb()` - Drizzle database instance
- `getRedis()` - ioredis client
- Both have `close*()` functions for graceful shutdown


<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

*No recent activity*
</claude-mem-context>